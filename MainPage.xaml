<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="firmware_upgrade.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Name="PageRef"
    BackgroundColor="{AppThemeBinding Light={StaticResource Gray100},
                                      Dark={StaticResource Gray950}}">

    <Grid>
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="20">

                <!--  Header Section  -->
                <Border
                    BackgroundColor="{AppThemeBinding Light={StaticResource Primary},
                                                      Dark={StaticResource PrimaryDark}}"
                    StrokeShape="RoundRectangle 16"
                    StrokeThickness="0">
                    <VerticalStackLayout Padding="24" Spacing="12">
                        <Image
                            Aspect="AspectFit"
                            HeightRequest="80"
                            HorizontalOptions="Center"
                            SemanticProperties.Description="Firmware upgrade application logo"
                            Source="dotnet_bot.png" />

                        <Label
                            FontAttributes="Bold"
                            FontSize="28"
                            HorizontalOptions="Center"
                            Text="Firmware Upgrade"
                            TextColor="White" />

                        <Label
                            FontSize="16"
                            HorizontalOptions="Center"
                            Opacity="0.9"
                            Text="Manage your device firmware updates"
                            TextColor="White" />
                    </VerticalStackLayout>
                </Border>

                <!--  Devices Section  -->
                <VerticalStackLayout Spacing="12">
                    <Label
                        FontAttributes="Bold"
                        FontSize="20"
                        Text="Nearby Bluetooth Devices"
                        TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                    Dark={StaticResource Gray100}}" />

                    <CollectionView
                        x:Name="DevicesListView"
                        ItemsSource="{Binding Devices}"
                        SelectionMode="None">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout ItemSpacing="12" Orientation="Vertical" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    BackgroundColor="{AppThemeBinding Light=White,
                                                                      Dark={StaticResource Gray900}}"
                                    Stroke="{AppThemeBinding Light={StaticResource Gray200},
                                                             Dark={StaticResource Gray700}}"
                                    StrokeShape="RoundRectangle 12"
                                    StrokeThickness="1">
                                    <Border.Shadow>
                                        <Shadow
                                            Brush="{AppThemeBinding Light={StaticResource Gray300},
                                                                    Dark={StaticResource Gray800}}"
                                            Opacity="0.3"
                                            Radius="8"
                                            Offset="0,2" />
                                    </Border.Shadow>

                                    <Grid Padding="20" RowSpacing="16">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <!--  Device Info with Menu Button  -->
                                        <Grid Grid.Row="0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <VerticalStackLayout Grid.Column="0" Spacing="4">
                                                <Label
                                                    FontAttributes="Bold"
                                                    FontSize="16"
                                                    Text="{Binding Name}"
                                                    TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                                                Dark={StaticResource Gray100}}" />

                                                <Label
                                                    FontSize="12"
                                                    LineBreakMode="TailTruncation"
                                                    Text="{Binding Id}"
                                                    TextColor="{AppThemeBinding Light={StaticResource Gray600},
                                                                                Dark={StaticResource Gray400}}" />

                                                <!--  Connection Status  -->
                                                <StackLayout Orientation="Horizontal" Spacing="8">
                                                    <Ellipse
                                                        Fill="{Binding IsConnected, Converter={StaticResource BoolToConnectionColorConverter}}"
                                                        HeightRequest="8"
                                                        VerticalOptions="Center"
                                                        WidthRequest="8" />
                                                    <Label
                                                        FontSize="12"
                                                        Text="{Binding IsConnected, Converter={StaticResource BoolToConnectionStatusConverter}}"
                                                        TextColor="{AppThemeBinding Light={StaticResource Gray600},
                                                                                    Dark={StaticResource Gray400}}" />
                                                </StackLayout>
                                            </VerticalStackLayout>

                                            <!--  Three Dots Menu Button  -->
                                            <Button
                                                x:Name="MenuButton"
                                                Grid.Column="1"
                                                BackgroundColor="Transparent"
                                                BorderWidth="0"
                                                Clicked="OnMenuButtonClicked"
                                                CommandParameter="{Binding .}"
                                                CornerRadius="20"
                                                FontAttributes="Bold"
                                                FontSize="20"
                                                HeightRequest="40"
                                                HorizontalOptions="End"
                                                Text="⋮"
                                                TextColor="{AppThemeBinding Light={StaticResource Gray600},
                                                                            Dark={StaticResource Gray400}}"
                                                VerticalOptions="Start"
                                                WidthRequest="40" />
                                        </Grid>

                                        <!--  Progress Section  -->
                                        <VerticalStackLayout
                                            Grid.Row="1"
                                            IsVisible="{Binding IsUpgradeInProgress}"
                                            Spacing="8">
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="14"
                                                Text="Upgrade Progress"
                                                TextColor="{AppThemeBinding Light={StaticResource Gray700},
                                                                            Dark={StaticResource Gray300}}" />

                                            <ProgressBar
                                                HeightRequest="6"
                                                Progress="{Binding UpgradeProgress, Converter={StaticResource PercentToDoubleConverter}}"
                                                ProgressColor="{StaticResource Primary}" />

                                            <Label
                                                FontSize="12"
                                                HorizontalOptions="End"
                                                Text="{Binding UpgradeProgress, StringFormat='{0}% Complete'}"
                                                TextColor="{AppThemeBinding Light={StaticResource Gray600},
                                                                            Dark={StaticResource Gray400}}" />
                                        </VerticalStackLayout>

                                        <!--  Action Buttons  -->
                                        <HorizontalStackLayout Grid.Row="2" Spacing="12">
                                            <Button
                                                BackgroundColor="{Binding IsConnected, Converter={StaticResource BoolToConnectButtonColorConverter}}"
                                                Command="{Binding BindingContext.ConnectCommand, Source={x:Reference PageRef}}"
                                                CommandParameter="{Binding .}"
                                                CornerRadius="8"
                                                FontAttributes="Bold"
                                                FontSize="14"
                                                HeightRequest="40"
                                                HorizontalOptions="FillAndExpand"
                                                Text="{Binding IsConnected, Converter={StaticResource BoolToConnectButtonTextConverter}}"
                                                TextColor="White" />

                                            <Button
                                                BackgroundColor="{AppThemeBinding Light={StaticResource Secondary},
                                                                                  Dark={StaticResource SecondaryDark}}"
                                                Command="{Binding BindingContext.GetDeviceInfoCommand, Source={x:Reference PageRef}}"
                                                CommandParameter="{Binding .}"
                                                CornerRadius="8"
                                                FontAttributes="Bold"
                                                FontSize="14"
                                                HeightRequest="40"
                                                HorizontalOptions="FillAndExpand"
                                                Text="Quick Info"
                                                TextColor="White" />
                                        </HorizontalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <ContentView>
                                <VerticalStackLayout
                                    Padding="40"
                                    HorizontalOptions="Center"
                                    Spacing="16"
                                    VerticalOptions="Center">
                                    <Label
                                        FontSize="48"
                                        HorizontalOptions="Center"
                                        Text="📱" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="18"
                                        HorizontalOptions="Center"
                                        Text="No devices found"
                                        TextColor="{AppThemeBinding Light={StaticResource Gray600},
                                                                    Dark={StaticResource Gray400}}" />
                                    <Label
                                        FontSize="14"
                                        HorizontalOptions="Center"
                                        HorizontalTextAlignment="Center"
                                        Text="Make sure Bluetooth is enabled and devices are nearby"
                                        TextColor="{AppThemeBinding Light={StaticResource Gray500},
                                                                    Dark={StaticResource Gray500}}" />
                                </VerticalStackLayout>
                            </ContentView>
                        </CollectionView.EmptyView>
                    </CollectionView>
                </VerticalStackLayout>

                <!--  Bottom spacing  -->
                <BoxView HeightRequest="20" IsVisible="False" />
            </VerticalStackLayout>
        </ScrollView>

        <!--  Popup Menu Overlay  -->
        <Border
            x:Name="MenuPopup"
            Margin="20,100,20,0"
            BackgroundColor="{AppThemeBinding Light=White,
                                              Dark={StaticResource Gray800}}"
            HorizontalOptions="End"
            IsVisible="False"
            Stroke="{AppThemeBinding Light={StaticResource Gray300},
                                     Dark={StaticResource Gray600}}"
            StrokeShape="RoundRectangle 8"
            StrokeThickness="1"
            VerticalOptions="Start"
            WidthRequest="160"
            ZIndex="1000">
            <Border.Shadow>
                <Shadow
                    Brush="{AppThemeBinding Light={StaticResource Gray400},
                                            Dark={StaticResource Gray900}}"
                    Opacity="0.4"
                    Radius="12"
                    Offset="0,4" />
            </Border.Shadow>

            <VerticalStackLayout Spacing="0">
                <!--  Upgrade Bootloader Option  -->
                <Button
                    Padding="12,0"
                    BackgroundColor="Transparent"
                    BorderWidth="0"
                    Command="{Binding OnStartBootloaderUpradeCommand}"
                    CommandParameter="{Binding SelectedDevice}"
                    CornerRadius="0"
                    FontSize="14"
                    HeightRequest="44"
                    HorizontalOptions="FillAndExpand"
                    Text="Upgrade Bootloader"
                    TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                Dark={StaticResource Gray100}}" />

                <Button
                    Padding="12,0"
                    BackgroundColor="Transparent"
                    BorderWidth="0"
                    Command="{Binding OnStartSensorUpradeCommand}"
                    CommandParameter="{Binding SelectedDevice}"
                    CornerRadius="0"
                    FontSize="14"
                    HeightRequest="44"
                    HorizontalOptions="FillAndExpand"
                    Text="Upgrade Sensor"
                    TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                Dark={StaticResource Gray100}}" />

                <Button
                    Padding="12,0"
                    BackgroundColor="Transparent"
                    BorderWidth="0"
                    Command="{Binding OnStartActorUpradeCommand}"
                    CommandParameter="{Binding SelectedDevice}"
                    CornerRadius="0"
                    FontSize="14"
                    HeightRequest="44"
                    HorizontalOptions="FillAndExpand"
                    Text="Upgrade Actor"
                    TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                Dark={StaticResource Gray100}}" />


                <!--  Separator  -->
                <BoxView
                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray200},
                                                      Dark={StaticResource Gray600}}"
                    HeightRequest="1"
                    HorizontalOptions="FillAndExpand" />

                <!--  Get Software Version Option  -->
                <Button
                    Padding="12,0"
                    BackgroundColor="Transparent"
                    BorderWidth="0"
                    Command="{Binding GetSoftwareVersionCommand}"
                    CommandParameter="{Binding SelectedDevice}"
                    CornerRadius="0"
                    FontSize="14"
                    HeightRequest="44"
                    HorizontalOptions="FillAndExpand"
                    Text="Get Software Version"
                    TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                Dark={StaticResource Gray100}}" />

                <!--  Separator  -->
                <BoxView
                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray200},
                                                      Dark={StaticResource Gray600}}"
                    HeightRequest="1"
                    HorizontalOptions="FillAndExpand" />

                <!--  Device Info Option  -->
                <Button
                    Padding="12,0"
                    BackgroundColor="Transparent"
                    BorderWidth="0"
                    Command="{Binding GetDeviceDetailsCommand}"
                    CommandParameter="{Binding SelectedDevice}"
                    CornerRadius="0"
                    FontSize="14"
                    HeightRequest="44"
                    HorizontalOptions="FillAndExpand"
                    Text="Device Information"
                    TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                Dark={StaticResource Gray100}}" />
            </VerticalStackLayout>
        </Border>

        <!--  Invisible overlay to close menu when tapping outside  -->
        <BoxView
            x:Name="MenuOverlay"
            BackgroundColor="Transparent"
            HorizontalOptions="FillAndExpand"
            IsVisible="False"
            VerticalOptions="FillAndExpand"
            ZIndex="999">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnOverlayTapped" />
            </BoxView.GestureRecognizers>
        </BoxView>
    </Grid>
</ContentPage>
